/*
Mr. Daniel Brewster sat in his luxurious suite at the Cosmopolis, smoking one of his admirable cigars and chatting with his old friend, Professor Binstead. A stranger who had only encountered Mr. Brewster in the lobby of the hotel would have been surprised at the appearance of his sitting-room, for it had none of the rugged simplicity which was the keynote of its owner's personal appearance. Daniel Brewster was a man with a hobby. He was what Parker, his valet, termed a connoozer. His educated taste in Art was one of the things which went to make the Cosmopolis different from and superior to other New York hotels. He had personally selected the tapestries in the dining-room and the various paintings throughout the building. And in his private capacity he was an enthusiastic collector of things which Professor Binstead, whose tastes lay in the same direction, would have stolen without a twinge of conscience if he could have got the chance.

The professor, a small man of middle age who wore tortoiseshell-rimmed spectacles, flitted covetously about the room, inspecting its treasures with a glistening eye. In a corner, Parker, a grave, lean individual, bent over the chafing-dish, in which he was preparing for his employer and his guest their simple lunch.

"Brewster," said Professor Binstead, pausing at the mantelpiece.

Mr. Brewster looked up amiably. He was in placid mood to-day. Two weeks and more had passed since the meeting with Archie recorded in the previous chapter, and he had been able to dismiss that disturbing affair from his mind. Since then, everything had gone splendidly with Daniel Brewster, for he had just accomplished his ambition of the moment by completing the negotiations for the purchase of a site further down-town, on which he proposed to erect a new hotel. He liked building hotels. He had the Cosmopolis, his first-born, a summer hotel in the mountains, purchased in the previous year, and he was toying with the idea of running over to England and putting up another in London, That, however, would have to wait. Meanwhile, he would concentrate on this new one down-town. It had kept him busy and worried, arranging for securing the site; but his troubles were over now.

"Yes?" he said.

Professor Binstead had picked up a small china figure of delicate workmanship. It represented a warrior of pre-khaki days advancing with a spear upon some adversary who, judging from the contented expression on the warrior's face, was smaller than himself.

"Where did you get this?"

"That? Mawson, my agent, found it in a little shop on the east side."

"Where's the other? There ought to be another. These things go in pairs. They're valueless alone."

Mr. Brewster's brow clouded.

"I know that," he said shortly. "Mawson's looking for the other one everywhere. If you happen across it, I give you carte blanche to buy it for me."

"It must be somewhere."

"Yes. If you find it, don't worry about the expense. I'll settle up, no matter what it is."

"I'll bear it in mind," said Professor Binstead. "It may cost you a lot of money. I suppose you know that."

"I told you I don't care what it costs."

"It's nice to be a millionaire," sighed Professor Binstead.

"Luncheon is served, sir," said Parker.

He had stationed himself in a statutesque pose behind Mr. Brewster's chair, when there was a knock at the door. He went to the door, and returned with a telegram.

"Telegram for you, sir."

Mr. Brewster nodded carelessly. The contents of the chafing-dish had justified the advance advertising of their odour, and he was too busy to be interrupted.

"Put it down. And you needn't wait, Parker."

"Very good, sir."

The valet withdrew, and Mr. Brewster resumed his lunch.

"Aren't you going to open it?" asked Professor Binstead, to whom a telegram was a telegram.

"It can wait. I get them all day long. I expect it's from Lucille, saying what train she's making."

"She returns to-day?"

"Yes, Been at Miami." Mr. Brewster, having dwelt at adequate length on the contents of the chafing-dish, adjusted his glasses and took up the envelope. "I shall be glad--Great Godfrey!"

He sat staring at the telegram, his mouth open. His friend eyed him solicitously.

"No bad news, I hope?"

Mr. Brewster gurgled in a strangled way.

"Bad news? Bad--? Here, read it for yourself."

Professor Binstead, one of the three most inquisitive men in New York, took the slip of paper with gratitude.

"'Returning New York to-day with darling Archie,'" he read. "'Lots of love from us both. Lucille.'" He gaped at his host. "Who is Archie?" he enquired.

"Who is Archie?" echoed Mr. Brewster helplessly. "Who is--? That's just what I would like to know."

"'Darling Archie,'" murmured the professor, musing over the telegram. "'Returning to-day with darling Archie.' Strange!"

Mr. Brewster continued to stare before him. When you send your only daughter on a visit to Miami minus any entanglements and she mentions in a telegram that she has acquired a darling Archie, you are naturally startled. He rose from the table with a bound. It had occurred to him that by neglecting a careful study of his mail during the past week, as was his bad habit when busy, he had lost an opportunity of keeping abreast with current happenings. He recollected now that a letter had arrived from Lucille some time ago, and that he had put it away unopened till he should have leisure to read it. Lucille was a dear girl, he had felt, but her letters when on a vacation seldom contained anything that couldn't wait a few days for a reading. He sprang for his desk, rummaged among his papers, and found what he was seeking.

It was a long letter, and there was silence in the room for some moments while he mastered its contents. Then he turned to the professor, breathing heavily.

"Good heavens!"

"Yes?" said Professor Binstead eagerly. "Yes?"

"Good Lord!"

"Well?"

"Good gracious!"

"What is it?" demanded the professor in an agony.

Mr. Brewster sat down again with a thud.

"She's married!"

"Married!"

"Married! To an Englishman!"

"Bless my soul!"

"She says," proceeded Mr. Brewster, referring to the letter again, "that they were both so much in love that they simply had to slip off and get married, and she hopes I won't be cross. Cross!" gasped Mr. Brewster, gazing wildly at his friend.

"Very disturbing!"

"Disturbing! You bet it's disturbing! I don't know anything about the fellow. Never heard of him in my life. She says he wanted a quiet wedding because he thought a fellow looked such a chump getting married! And I must love him, because he's all set to love me very much!"

"Extraordinary!"

Mr. Brewster put the letter down.

"An Englishman!"

"I have met some very agreeable Englishmen," said Professor Binstead.

"I don't like Englishmen," growled Mr. Brewster. "Parker's an Englishman."

"Your valet?"

"Yes. I believe he wears my shirts on the sly,'" said Mr. Brewster broodingly, "If I catch him--! What would you do about this, Binstead?"

"Do?" The professor considered the point judiciary. "Well, really, Brewster, I do not see that there is anything you can do. You must simply wait and meet the man. Perhaps he will turn out an admirable son-in-law."

"H'm!" Mr. Brewster declined to take an optimistic view. "But an Englishman, Binstead!" he said with pathos. "Why," he went on, memory suddenly stirring, "there was an Englishman at this hotel only a week or two ago who went about knocking it in a way that would have amazed you! Said it was a rotten place! MY hotel!"

Professor Binstead clicked his tongue sympathetically. He understood his friend's warmth.
 */
const $ = new Env('ç¯çƒæŒ‘æˆ˜èµ›');

const notify = $.isNode() ? require('./sendNotify') : '';
//Node.jsç”¨æˆ·è¯·åœ¨jdCookie.jså¤„å¡«å†™äº¬ä¸œck;
const jdCookieNode = $.isNode() ? require('./jdCookie.js') : '';
let jdNotify = false;//æ˜¯å¦å…³é—­é€šçŸ¥ï¼Œfalseæ‰“å¼€é€šçŸ¥æ¨é€ï¼Œtrueå…³é—­é€šçŸ¥æ¨é€
const randomCount = $.isNode() ? 20 : 5;
//IOSç­‰ç”¨æˆ·ç›´æ¥ç”¨NobyDaçš„jd cookie

let cookiesArr = [], cookie = '', message;
if ($.isNode()) {
  Object.keys(jdCookieNode).forEach((item) => {
    cookiesArr.push(jdCookieNode[item])
  })
  if (process.env.JD_DEBUG && process.env.JD_DEBUG === 'false') console.log = () => {
  };
} else {
  let cookiesData = $.getdata('CookiesJD') || "[]";
  cookiesData = jsonParse(cookiesData);
  cookiesArr = cookiesData.map(item => item.cookie);
  cookiesArr.reverse();
  cookiesArr.push(...[$.getdata('CookieJD2'), $.getdata('CookieJD')]);
  cookiesArr.reverse();
  cookiesArr = cookiesArr.filter(item => item !== "" && item !== null && item !== undefined);
}

const JD_API_HOST = 'https://api.m.jd.com/', actCode = 'visa-card-001';
const inviteCodes = [""];
$.invites = [];








!(async () => {
  await requireConfig();
  if (!cookiesArr[0]) {
    $.msg($.name, 'ã€æç¤ºã€‘è¯·å…ˆè·å–äº¬ä¸œè´¦å·ä¸€cookie\nç›´æ¥ä½¿ç”¨NobyDaçš„äº¬ä¸œç­¾åˆ°è·å–', 'https://bean.m.jd.com/bean/signIndex.action', {"open-url": "https://bean.m.jd.com/bean/signIndex.action"});
    return;
  }
  for (let i = 0; i < 3; i++) {
    if (cookiesArr[i]) {
      cookie = cookiesArr[i];
      $.UserName = decodeURIComponent(cookie.match(/pt_pin=(.+?);/) && cookie.match(/pt_pin=(.+?);/)[1])
      $.index = i + 1;
      $.isLogin = true;
      $.nickName = '';
      message = '';
      await TotalBean();
      console.log(`\n******å¼€å§‹ã€äº¬ä¸œè´¦å·${$.index}ã€‘${$.nickName || $.UserName}*********\n`);
      if (!$.isLogin) {
        $.msg($.name, `ã€æç¤ºã€‘cookieå·²å¤±æ•ˆ`, `äº¬ä¸œè´¦å·${$.index} ${$.nickName || $.UserName}\nè¯·é‡æ–°ç™»å½•è·å–\nhttps://bean.m.jd.com/bean/signIndex.action`, {"open-url": "https://bean.m.jd.com/bean/signIndex.action"});

        if ($.isNode()) {
          await notify.sendNotify(`${$.name}cookieå·²å¤±æ•ˆ - ${$.UserName}`, `äº¬ä¸œè´¦å·${$.index} ${$.UserName}\nè¯·é‡æ–°ç™»å½•è·å–cookie`);
        }
        continue
      }
      await shareCodesFormat()
      await jdGlobal()
    }
  }
  for (let i = 0; i < cookiesArr.length; i++) {
    if (cookiesArr[i]) {
      cookie = cookiesArr[i];
      $.canHelp = true;
      for (let code of $.invites) {
        if (!code) continue
        await helpFriend(code)
        if(!$.canHelp) break
        await $.wait(1000)
      }
    }
  }
})()
  .catch((e) => {
    $.log('', `âŒ ${$.name}, å¤±è´¥! åŸå› : ${e}!`, '')
  })
  .finally(() => {
    $.done();
  })

async function jdGlobal() {
  try {
    $.earn = 0
    $.score = 0
    $.beans = 0
    await getHome()
    await getTask()
    await getHome(true)
    await helpFriends()
    await showMsg()
  } catch (e) {
    $.logErr(e)
  }
}

async function helpFriends() {
  $.canHelp = true
  for (let code of $.newShareCodes) {
    if (!code) continue
    await helpFriend(code)
    if(!$.canHelp) break
    await $.wait(1000)
  }
}


function showMsg() {
  return new Promise(resolve => {
    message += `æœ¬æ¬¡è¿è¡Œè·å¾—${$.earn}é‡Œç¨‹ï¼Œ${$.beans}äº¬è±†ï¼Œå…±è®¡${$.score}é‡Œç¨‹`
    $.msg($.name, '', `äº¬ä¸œè´¦å·${$.index}${$.nickName}\n${message}`);
    resolve()
  })
}

async function getHome(info = false) {
  return new Promise(resolve => {
    $.get(taskUrl("mainInfo", {"activityCode": actCode}), async (err, resp, data) => {
      try {
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
        } else {
          if (safeGet(data)) {
            data = JSON.parse(data);
            if (data['code'] === '0') {
              const {activityCalendar, activityStations} = data.result.data
              if (info) {
                $.earn = parseInt(data.result.data.mileageAmount) - $.score
                let station = activityStations.filter(vo => vo.unlock === true)
                for (let vo of station) {
                  let ids = []
                  for (let bo of vo.rewards) {
                    if (bo['unlock'] && !bo['received']) {
                      if (/^[0-9]+.?[0-9]*$/.test(bo['couponPrice'])) {
                        $.beans += parseInt(bo['couponPrice'])
                      }
                      console.log(`å»é¢†å– ${/^[0-9]+.?[0-9]*$/.test(bo['couponPrice']) ? bo['couponPrice'] + 'äº¬è±†' : bo['couponPrice']} å¥–åŠ±`)
                      ids.push(bo['id'])
                    }
                  }
                  if (ids.length) {
                    await receiveReward({"stationId": vo['id'], "rewardIds": ids, "activityCode": actCode})
                    await $.wait(1000)
                  }
                }
              } else {
                console.log(`å½“å‰æ´»åŠ¨ï¼šç¬¬${activityCalendar.currDays}/${activityCalendar.totalDays}å¤©`)
              }
              $.score = parseInt(data.result.data.mileageAmount)
            }
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })
}

async function getTask() {
  return new Promise(resolve => {
    $.get(taskUrl("myTask", {"activityCode": actCode}), async (err, resp, data) => {
      try {
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
        } else {
          if (safeGet(data)) {
            data = JSON.parse(data);
            if (data['code'] === '0') {
              const {timeLimitTask, commonTask} = data.result.data
              let task = [...timeLimitTask, ...commonTask]
              for (let vo of task) {
                if (vo['taskName'] === 'æ¯æ—¥é‚€è¯·å¥½å‹') {
                  console.log(`æ‚¨çš„å¥½å‹åŠ©åŠ›ç ä¸º ${vo['jingCommand']['keyOpenapp'].match(/masterPin":"(.*)","/)[1]}`)
                  $.invites.push(vo['jingCommand']['keyOpenapp'].match(/masterPin":"(.*)","/)[1]);
                }
                if (['70', '50', '30', '40'].includes(vo['taskType'])) {
                  if (vo['executedTimes'] === vo['totalTimes']) {
                    console.log(`${vo['taskName']}ä»»åŠ¡å·²å®Œæˆ`)
                  } else {
                    console.log(`å»åš${vo['taskName']}ä»»åŠ¡`)
                    for (let i = vo['executedTimes']; i < vo['totalTimes']; ++i) {
                      await doTask({
                        "taskId": vo['taskId'],
                        "itemId": vo['itemId'],
                        "viewSeconds": vo['viewSeconds'],
                        "activityCode": actCode
                      })
                    }
                  }
                }
              }
            }
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })
}

async function doTask(body) {
  return new Promise(resolve => {
    $.get(taskUrl("taskRun", body), async (err, resp, data) => {
      try {
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
        } else {
          if (safeGet(data)) {
            data = JSON.parse(data);
            if (data['code'] === '0') {
              console.log(data['result']['message'])

            } else {
              console.log(JSON.stringify(data))
            }
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })
}

async function helpFriend(inviterPin) {
  return new Promise(resolve => {
    $.get(taskUrl("inviteHelp", {
      "inviterPin": inviterPin,
      "taskId": "3",
      "pageType": "doHelp",
      "headImg": "",
      "username": "",
      "activityCode": actCode
    }), async (err, resp, data) => {
      try {
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
        } else {
          if (safeGet(data)) {
            data = JSON.parse(data);
            if (data['code'] === '0') {
              console.log(data['result']['message'])
              if(data['result']['message']==='æ‚¨ä»Šå¤©çš„åŠ©åŠ›æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼Œæ˜å¤©å†è¯•è¯•å§~') $.canHelp = false
            } else {
              console.log(JSON.stringify(data))
            }
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })
}

async function receiveReward(body) {
  return new Promise(resolve => {
    $.get(taskUrl("receiveRewardVisa", body), async (err, resp, data) => {
      try {
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
        } else {
          if (safeGet(data)) {
            data = JSON.parse(data);
            if (data['code'] === '0') {
              console.log(data['result']['message'])

            } else {
              console.log(JSON.stringify(data))
            }
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
  })
}

getArrRandomly = (arr) => {
    var len = arr.length;
    for (var i = len - 1; i >= 0; i--) {
      var randomIndex = Math.floor(Math.random() * (i + 1));
      var itemIndex = arr[randomIndex];
      arr[randomIndex] = arr[i];
      arr[i] = itemIndex;
    }
    return arr;
  }
  
 
  getRandomArr = (arr=[],num) => {
    const tmpArr = getArrRandomly(arr);
    let arrList = [];
    for (let i = 0; i < num; i++) {
      arrList.push(tmpArr[i]);
    };
    return arrList;
  }


function readShareCode() {
  console.log(`å¼€å§‹è¯»å–æœ±ä¸½å¨œã€‚ã€‚ã€‚`)
  return new Promise(async resolve => {
    $.get({url: `https://raw.githubusercontent.com/jd1994527314/iosrule/cs/JD_TG/GJ.json`, 'timeout': 10000}, (err, resp, data) => {
      try {
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
        } else {
          if (data) {
            console.log(`éšæœºå–${randomCount}ä¸ªç æ”¾åˆ°æ‚¨å›ºå®šçš„äº’åŠ©ç åé¢(ä¸å½±å“å·²æœ‰å›ºå®šäº’åŠ©)`)
            data = JSON.parse(data);
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve(data);
      }
    })
    await $.wait(10000);
    resolve()
  })
}
//æ ¼å¼åŒ–åŠ©åŠ›ç 
function shareCodesFormat() {
  return new Promise(async resolve => {
    // console.log(`ç¬¬${$.index}ä¸ªäº¬ä¸œè´¦å·çš„åŠ©åŠ›ç :::${$.shareCodesArr[$.index - 1]}`)
    $.newShareCodes = [];
    if ($.shareCodesArr[$.index - 1]) {
      $.newShareCodes = $.shareCodesArr[$.index - 1].split('@');
    } else {
      console.log(`ç”±äºæ‚¨ç¬¬${$.index}ä¸ªäº¬ä¸œè´¦å·æœªæä¾›shareCode,å°†é‡‡çº³æœ¬è„šæœ¬è‡ªå¸¦çš„åŠ©åŠ›ç \n`)
      const tempIndex = $.index > inviteCodes.length ? (inviteCodes.length - 1) : ($.index - 1);
      $.newShareCodes = inviteCodes[tempIndex].split('@');
    }
    const readShareCodeRes = await readShareCode();
    
    if (readShareCodeRes && readShareCodeRes.code === 200) {
$.newShareCodes = [...new Set([...$.newShareCodes, ...(getRandomArr(getArrRandomly(readShareCodeRes.data),randomCount)|| [])])];
    

    
    console.log(`ç¬¬${$.index}ä¸ªäº¬ä¸œè´¦å·å°†è¦åŠ©åŠ›çš„å¥½å‹${JSON.stringify($.newShareCodes)}`)

}
else

console.log(`æ— äº’åŠ©ç `)



    resolve();
  })
}


function requireConfig() {
  return new Promise(resolve => {
    console.log(`å¼€å§‹è·å–${$.name}é…ç½®æ–‡ä»¶\n`);
    //Node.jsç”¨æˆ·è¯·åœ¨jdCookie.jså¤„å¡«å†™äº¬ä¸œck;
    let shareCodes = []
    console.log(`å…±${cookiesArr.length}ä¸ªäº¬ä¸œè´¦å·\n`);
    if ($.isNode() && process.env.JDGLOBAL_SHARECODES) {
      if (process.env.JDGLOBAL_SHARECODES.indexOf('\n') > -1) {
        shareCodes = process.env.JDGLOBAL_SHARECODES.split('\n');
      } else {
        shareCodes = process.env.JDGLOBAL_SHARECODES.split('&');
      }
    }
    $.shareCodesArr = [];
    if ($.isNode()) {
      Object.keys(shareCodes).forEach((item) => {
        if (shareCodes[item]) {
          $.shareCodesArr.push(shareCodes[item])
        }
      })
    }
    console.log(`æ‚¨æä¾›äº†${$.shareCodesArr.length}ä¸ªè´¦å·çš„${$.name}PKåŠ©åŠ›ç \n`);
    resolve()
  })
}

function taskUrl(function_id, body = {}) {
  return {
    url: `${JD_API_HOST}/client.action?functionId=${function_id}&body=${escape(JSON.stringify(body))}&appid=global_mart&time=${new Date().getTime()}`,
    headers: {
      "Cookie": cookie,
      "origin": "https://h5.m.jd.com",
      "referer": "https://h5.m.jd.com/",
      'Content-Type': 'application/x-www-form-urlencoded',
      "User-Agent": $.isNode() ? (process.env.JD_USER_AGENT ? process.env.JD_USER_AGENT : (require('./USER_AGENTS').USER_AGENT)) : ($.getdata('JDUA') ? $.getdata('JDUA') : "jdapp;iPhone;9.2.2;14.2;%E4%BA%AC%E4%B8%9C/9.2.2 CFNetwork/1206 Darwin/20.1.0")
    }
  }
}

function taskPostUrl(function_id, body = {}, function_id2) {
  let url = `${JD_API_HOST}`;
  if (function_id2) {
    url += `?functionId=${function_id2}`;
  }
  return {
    url,
    body: `functionId=${function_id}&body=${escape(JSON.stringify(body))}&client=wh5&clientVersion=1.0.0`,
    headers: {
      "Cookie": cookie,
      "origin": "https://h5.m.jd.com",
      "referer": "https://h5.m.jd.com/",
      'Content-Type': 'application/x-www-form-urlencoded',
      "User-Agent": $.isNode() ? (process.env.JD_USER_AGENT ? process.env.JD_USER_AGENT : (require('./USER_AGENTS').USER_AGENT)) : ($.getdata('JDUA') ? $.getdata('JDUA') : "jdapp;iPhone;9.2.2;14.2;%E4%BA%AC%E4%B8%9C/9.2.2 CFNetwork/1206 Darwin/20.1.0")
    }
  }
}

function TotalBean() {
  return new Promise(async resolve => {
    const options = {
      "url": `https://wq.jd.com/user/info/QueryJDUserInfo?sceneval=2`,
      "headers": {
        "Accept": "application/json,text/plain, */*",
        "Content-Type": "application/x-www-form-urlencoded",
        "Accept-Encoding": "gzip, deflate, br",
        "Accept-Language": "zh-cn",
        "Connection": "keep-alive",
        "Cookie": cookie,
        "Referer": "https://wqs.jd.com/my/jingdou/my.shtml?sceneval=2",
        "User-Agent": $.isNode() ? (process.env.JD_USER_AGENT ? process.env.JD_USER_AGENT : (require('./USER_AGENTS').USER_AGENT)) : ($.getdata('JDUA') ? $.getdata('JDUA') : "jdapp;iPhone;9.2.2;14.2;%E4%BA%AC%E4%B8%9C/9.2.2 CFNetwork/1206 Darwin/20.1.0")
      }
    }
    $.post(options, (err, resp, data) => {
      try {
        if (err) {
          console.log(`${JSON.stringify(err)}`)
          console.log(`${$.name} APIè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘è·¯é‡è¯•`)
        } else {
          if (data) {
            data = JSON.parse(data);
            if (data['retcode'] === 13) {
              $.isLogin = false; //cookieè¿‡æœŸ
              return
            }
            $.nickName = data['base'].nickname;
          } else {
            console.log(`äº¬ä¸œæœåŠ¡å™¨è¿”å›ç©ºæ•°æ®`)
          }
        }
      } catch (e) {
        $.logErr(e, resp)
      } finally {
        resolve();
      }
    })
  })
}

function safeGet(data) {
  try {
    if (typeof JSON.parse(data) == "object") {
      return true;
    }
  } catch (e) {
    console.log(e);
    console.log(`äº¬ä¸œæœåŠ¡å™¨è®¿é—®æ•°æ®ä¸ºç©ºï¼Œè¯·æ£€æŸ¥è‡ªèº«è®¾å¤‡ç½‘ç»œæƒ…å†µ`);
    return false;
  }
}

function jsonParse(str) {
  if (typeof str == "string") {
    try {
      return JSON.parse(str);
    } catch (e) {
      console.log(e);
      $.msg($.name, '', 'è¯·å‹¿éšæ„åœ¨BoxJsè¾“å…¥æ¡†ä¿®æ”¹å†…å®¹\nå»ºè®®é€šè¿‡è„šæœ¬å»è·å–cookie')
      return [];
    }
  }
}

// prettier-ignore
function Env(t,e){"undefined"!=typeof process&&JSON.stringify(process.env).indexOf("GITHUB")>-1&&process.exit(0);class s{constructor(t){this.env=t}send(t,e="GET"){t="string"==typeof t?{url:t}:t;let s=this.get;return"POST"===e&&(s=this.post),new Promise((e,i)=>{s.call(this,t,(t,s,r)=>{t?i(t):e(s)})})}get(t){return this.send.call(this.env,t)}post(t){return this.send.call(this.env,t,"POST")}}return new class{constructor(t,e){this.name=t,this.http=new s(this),this.data=null,this.dataFile="box.dat",this.logs=[],this.isMute=!1,this.isNeedRewrite=!1,this.logSeparator="\n",this.startTime=(new Date).getTime(),Object.assign(this,e),this.log("",`ğŸ””${this.name}, å¼€å§‹!`)}isNode(){return"undefined"!=typeof module&&!!module.exports}isQuanX(){return"undefined"!=typeof $task}isSurge(){return"undefined"!=typeof $httpClient&&"undefined"==typeof $loon}isLoon(){return"undefined"!=typeof $loon}toObj(t,e=null){try{return JSON.parse(t)}catch{return e}}toStr(t,e=null){try{return JSON.stringify(t)}catch{return e}}getjson(t,e){let s=e;const i=this.getdata(t);if(i)try{s=JSON.parse(this.getdata(t))}catch{}return s}setjson(t,e){try{return this.setdata(JSON.stringify(t),e)}catch{return!1}}getScript(t){return new Promise(e=>{this.get({url:t},(t,s,i)=>e(i))})}runScript(t,e){return new Promise(s=>{let i=this.getdata("@chavy_boxjs_userCfgs.httpapi");i=i?i.replace(/\n/g,"").trim():i;let r=this.getdata("@chavy_boxjs_userCfgs.httpapi_timeout");r=r?1*r:20,r=e&&e.timeout?e.timeout:r;const[o,h]=i.split("@"),n={url:`http://${h}/v1/scripting/evaluate`,body:{script_text:t,mock_type:"cron",timeout:r},headers:{"X-Key":o,Accept:"*/*"}};this.post(n,(t,e,i)=>s(i))}).catch(t=>this.logErr(t))}loaddata(){if(!this.isNode())return{};{this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),s=this.fs.existsSync(t),i=!s&&this.fs.existsSync(e);if(!s&&!i)return{};{const i=s?t:e;try{return JSON.parse(this.fs.readFileSync(i))}catch(t){return{}}}}}writedata(){if(this.isNode()){this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),s=this.fs.existsSync(t),i=!s&&this.fs.existsSync(e),r=JSON.stringify(this.data);s?this.fs.writeFileSync(t,r):i?this.fs.writeFileSync(e,r):this.fs.writeFileSync(t,r)}}lodash_get(t,e,s){const i=e.replace(/\[(\d+)\]/g,".$1").split(".");let r=t;for(const t of i)if(r=Object(r)[t],void 0===r)return s;return r}lodash_set(t,e,s){return Object(t)!==t?t:(Array.isArray(e)||(e=e.toString().match(/[^.[\]]+/g)||[]),e.slice(0,-1).reduce((t,s,i)=>Object(t[s])===t[s]?t[s]:t[s]=Math.abs(e[i+1])>>0==+e[i+1]?[]:{},t)[e[e.length-1]]=s,t)}getdata(t){let e=this.getval(t);if(/^@/.test(t)){const[,s,i]=/^@(.*?)\.(.*?)$/.exec(t),r=s?this.getval(s):"";if(r)try{const t=JSON.parse(r);e=t?this.lodash_get(t,i,""):e}catch(t){e=""}}return e}setdata(t,e){let s=!1;if(/^@/.test(e)){const[,i,r]=/^@(.*?)\.(.*?)$/.exec(e),o=this.getval(i),h=i?"null"===o?null:o||"{}":"{}";try{const e=JSON.parse(h);this.lodash_set(e,r,t),s=this.setval(JSON.stringify(e),i)}catch(e){const o={};this.lodash_set(o,r,t),s=this.setval(JSON.stringify(o),i)}}else s=this.setval(t,e);return s}getval(t){return this.isSurge()||this.isLoon()?$persistentStore.read(t):this.isQuanX()?$prefs.valueForKey(t):this.isNode()?(this.data=this.loaddata(),this.data[t]):this.data&&this.data[t]||null}setval(t,e){return this.isSurge()||this.isLoon()?$persistentStore.write(t,e):this.isQuanX()?$prefs.setValueForKey(t,e):this.isNode()?(this.data=this.loaddata(),this.data[e]=t,this.writedata(),!0):this.data&&this.data[e]||null}initGotEnv(t){this.got=this.got?this.got:require("got"),this.cktough=this.cktough?this.cktough:require("tough-cookie"),this.ckjar=this.ckjar?this.ckjar:new this.cktough.CookieJar,t&&(t.headers=t.headers?t.headers:{},void 0===t.headers.Cookie&&void 0===t.cookieJar&&(t.cookieJar=this.ckjar))}get(t,e=(()=>{})){t.headers&&(delete t.headers["Content-Type"],delete t.headers["Content-Length"]),this.isSurge()||this.isLoon()?(this.isSurge()&&this.isNeedRewrite&&(t.headers=t.headers||{},Object.assign(t.headers,{"X-Surge-Skip-Scripting":!1})),$httpClient.get(t,(t,s,i)=>{!t&&s&&(s.body=i,s.statusCode=s.status),e(t,s,i)})):this.isQuanX()?(this.isNeedRewrite&&(t.opts=t.opts||{},Object.assign(t.opts,{hints:!1})),$task.fetch(t).then(t=>{const{statusCode:s,statusCode:i,headers:r,body:o}=t;e(null,{status:s,statusCode:i,headers:r,body:o},o)},t=>e(t))):this.isNode()&&(this.initGotEnv(t),this.got(t).on("redirect",(t,e)=>{try{if(t.headers["set-cookie"]){const s=t.headers["set-cookie"].map(this.cktough.Cookie.parse).toString();s&&this.ckjar.setCookieSync(s,null),e.cookieJar=this.ckjar}}catch(t){this.logErr(t)}}).then(t=>{const{statusCode:s,statusCode:i,headers:r,body:o}=t;e(null,{status:s,statusCode:i,headers:r,body:o},o)},t=>{const{message:s,response:i}=t;e(s,i,i&&i.body)}))}post(t,e=(()=>{})){if(t.body&&t.headers&&!t.headers["Content-Type"]&&(t.headers["Content-Type"]="application/x-www-form-urlencoded"),t.headers&&delete t.headers["Content-Length"],this.isSurge()||this.isLoon())this.isSurge()&&this.isNeedRewrite&&(t.headers=t.headers||{},Object.assign(t.headers,{"X-Surge-Skip-Scripting":!1})),$httpClient.post(t,(t,s,i)=>{!t&&s&&(s.body=i,s.statusCode=s.status),e(t,s,i)});else if(this.isQuanX())t.method="POST",this.isNeedRewrite&&(t.opts=t.opts||{},Object.assign(t.opts,{hints:!1})),$task.fetch(t).then(t=>{const{statusCode:s,statusCode:i,headers:r,body:o}=t;e(null,{status:s,statusCode:i,headers:r,body:o},o)},t=>e(t));else if(this.isNode()){this.initGotEnv(t);const{url:s,...i}=t;this.got.post(s,i).then(t=>{const{statusCode:s,statusCode:i,headers:r,body:o}=t;e(null,{status:s,statusCode:i,headers:r,body:o},o)},t=>{const{message:s,response:i}=t;e(s,i,i&&i.body)})}}time(t,e=null){const s=e?new Date(e):new Date;let i={"M+":s.getMonth()+1,"d+":s.getDate(),"H+":s.getHours(),"m+":s.getMinutes(),"s+":s.getSeconds(),"q+":Math.floor((s.getMonth()+3)/3),S:s.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(s.getFullYear()+"").substr(4-RegExp.$1.length)));for(let e in i)new RegExp("("+e+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?i[e]:("00"+i[e]).substr((""+i[e]).length)));return t}msg(e=t,s="",i="",r){const o=t=>{if(!t)return t;if("string"==typeof t)return this.isLoon()?t:this.isQuanX()?{"open-url":t}:this.isSurge()?{url:t}:void 0;if("object"==typeof t){if(this.isLoon()){let e=t.openUrl||t.url||t["open-url"],s=t.mediaUrl||t["media-url"];return{openUrl:e,mediaUrl:s}}if(this.isQuanX()){let e=t["open-url"]||t.url||t.openUrl,s=t["media-url"]||t.mediaUrl;return{"open-url":e,"media-url":s}}if(this.isSurge()){let e=t.url||t.openUrl||t["open-url"];return{url:e}}}};if(this.isMute||(this.isSurge()||this.isLoon()?$notification.post(e,s,i,o(r)):this.isQuanX()&&$notify(e,s,i,o(r))),!this.isMuteLog){let t=["","==============ğŸ“£ç³»ç»Ÿé€šçŸ¥ğŸ“£=============="];t.push(e),s&&t.push(s),i&&t.push(i),console.log(t.join("\n")),this.logs=this.logs.concat(t)}}log(...t){t.length>0&&(this.logs=[...this.logs,...t]),console.log(t.join(this.logSeparator))}logErr(t,e){const s=!this.isSurge()&&!this.isQuanX()&&!this.isLoon();s?this.log("",`â—ï¸${this.name}, é”™è¯¯!`,t.stack):this.log("",`â—ï¸${this.name}, é”™è¯¯!`,t)}wait(t){return new Promise(e=>setTimeout(e,t))}done(t={}){const e=(new Date).getTime(),s=(e-this.startTime)/1e3;this.log("",`ğŸ””${this.name}, ç»“æŸ! ğŸ•› ${s} ç§’`),this.log(),(this.isSurge()||this.isQuanX()||this.isLoon())&&$done(t)}}(t,e)}
